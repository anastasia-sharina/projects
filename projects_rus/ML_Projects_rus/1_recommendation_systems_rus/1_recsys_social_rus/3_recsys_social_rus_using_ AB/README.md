# A/B сервис рекомендаций (3_recsys_social_ru_using_AB)

Описание
- A/B сервис реализует детерминированное распределение пользователей на контрольную и тестовую группы (A/B) и выдаёт персональные рекомендации с использованием двух независимых моделей (control / test).
- Контролируемое поведение: для одних пользователей используется одна модель (control), для других — вторая (test). Результат возвращается вместе с информацией о группе (поле `exp_group`).
- Служит демонстрацией best-practices: централизованное подключение к БД через общий модуль `0_recsys_movies_ru_common/db_connect.py` (маскировка credentials), читабельные русские логи, документированный код для портфолио.

Архитектура / этапы пайплайна
1. Загрузка данных
   - Данные взаимодействий (feed_data) и признаки постов/пользователей загружаются из PostgreSQL через общий модуль `db_connect.get_engine()`.
   - Чтение больших таблиц выполняется чанками (batch load) для экономии памяти.
2. Подготовка признаков
   - Broadcast признаков пользователя на таблицу постов.
   - Добавление временных признаков (hour, month).
   - Приведение категориальных признаков к строковому типу, заполнение NaN.
3. A/B-распределение
   - Детерминированное распределение по md5(user_id + SALT). SALT задаётся переменной окружения `AB_SALT` (по умолчанию `"my_salt"`).
   - По умолчанию 50% — control, 50% — test.
4. Инференс и ранжирование
   - Для каждой группы используются свои признаки/порядок фич и соответствующая модель CatBoost.
   - Вычисляется вероятность лайка, фильтруются уже лайкнутые посты, осуществляется ранжирование и возвращаются top-N рекомендаций.
5. A/B-анализ
   - Сервис возвращает `exp_group` вместе с рекомендациями — удобно для приёма в систему A/B-аналитики.

Стек технологий
- Python 3.8+
- FastAPI (REST API)
- CatBoost (модели)
- Pandas, NumPy
- SQLAlchemy (подключение к PostgreSQL через общий модуль)
- PostgreSQL
- loguru (логирование)
- Docker (контейнеризация)

Метрики качества
- ROC-AUC — основная метрика для оценки ранжирования.
- Hitrate — показатель попадания рекомендаций в реальные лайки (используется при интеграционном тестировании и LMS).
- Feature importance — анализ вклада признаков в модель.

Безопасность
- Все credentials для подключения к БД читаются в одном месте: `0_recsys_movies_ru_common/db_connect.py`. В коде сервиса нет хардкоднутых логинов/паролей.
- Для локальной разработки: используйте `0_recsys_movies_ru_common/.env.example` → скопируйте в `0_recsys_movies_ru_common/.env` и заполните значения (НЕ коммитьте `.env`).
- В логах не выводятся полные переменные окружения и строки подключения. Логируются только безопасные сведения (например, наличие флага `IS_LMS` или basename файла модели).
- В production храните секреты в менеджере секретов или в переменных окружения CI/CD.

Переменные окружения, используемые сервисом
- IS_LMS — флаг окружения (если = "1", модели берутся из пути LMS).
- AB_SALT — соль для A/B распределения (опционально).
- DB_USER, DB_PASS, DB_HOST, DB_PORT, DB_NAME — читаются и используются общим модулем подключения (см. `0_recsys_movies_ru_common/.env.example`).

Установка зависимостей
```bash
# Установка зависимостей проекта (общий requirements в common)
pip install -r ../0_recsys_movies_ru_common/requirements.txt
```

Локальный запуск
1. Подготовьте локальный `.env`:
   - Скопируйте `0_recsys_movies_ru_common/.env.example` → `0_recsys_movies_ru_common/.env` и заполните значения.
2. Запустите сервис:
```bash
# из корня проекта (папка, где лежит пакет 3_recsys_movies_ru_using_AB)
uvicorn 3_recsys_movies_ru_using_AB.service:app --reload --port 8002
```
3. Пример запроса:
```python
import requests

r = requests.get(
    "http://localhost:8002/post/recommendations/",
    params={"id": 1000, "time": "2021-12-20T00:00:00", "limit": 5}
)
print(r.json())
```
Ожидаемый формат ответа:
```json
{
  "exp_group": "control",
  "recommendations": [
    {"id": 123, "text": "Описание поста...", "topic": "topic1"},
    ...
  ]
}
```

Docker
- Сборка и запуск через общий Dockerfile (как в основном README проекта). Пример:
```bash
# сборка (пример: PROJECT=ab, SERVICE_FILE=service.py)
docker build -t ml-dl-ab --build-arg PROJECT=ab --build-arg SERVICE_FILE=service.py .
# запуск (передаём env файл из common, пробрасываем порт 8002)
docker run --env-file ../0_recsys_movies_ru_common/.env -p 8002:8000 ml-dl-ab
```

Тестирование
- Юнит-тесты: рекомендуем добавить тесты для:
  - корректного распределения get_user_group (детерминированность),
  - функции calculate_features (формирование признаков),
  - эндпоинта API (FastAPI TestClient), проверка формата ответа.
- При интеграционном тестировании — проверять работу с реальной или mock БД (test fixtures).

Что важно для портфолио / примечания для ревьюеров
- Централизация секретов: `db_connect.py` в `0_recsys_movies_ru_common` устраняет дублирование строк подключения.
- Читабельные русские лог-сообщения и подробные комментарии в коде — облегчают ревью.
- Явное разделение этапов: загрузка данных → подготовка признаков → инференс → ранжирование.
- Пример запуска через Docker и использование `.env.example` демонстрируют готовность к production-пайплайну.

Контакты
Автор: Анастасия Шарина  
GitHub: https://github.com/anastasia-sharina